{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Osmeña Colleges</title>
    
    <!-- External Libraries -->
    <link href='https://cdn.boxicons.com/3.0.6/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="{% static 'css/studentDashboard.css' %}">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="{% static 'images/osme_logo.jpg' %}" class="sidebar-logo" alt="Osmeña Colleges Logo">
            <h2 class="sidebar-title">Osmeña Colleges</h2>
            <button class="sidebar-close" id="closeSidebarBtn" aria-label="Close sidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <ul class="menu">
                <li class="menu-item active" data-page="dashboard">
                    <i class='bx bx-dashboard'></i>
                    <span>Dashboard</span>
                </li>
                <li class="menu-item" data-page="evaluate">
                    <i class='bx bx-clipboard-check'></i>
                    <span>Evaluate Teachers</span>
                </li>
                <li class="menu-item" data-page="subjects">
                    <i class='bx bx-book'></i>
                    <span>My Subjects</span>
                </li>
                <li class="menu-item" data-page="history">
                    <i class='bx bx-history'></i>
                    <span>Evaluation History</span>
                </li>
                <li class="menu-item" data-page="announcements">
                    <i class='bx bx-bell'></i>
                    <span>Announcements</span>
                </li>
                <li class="menu-item" data-page="profile">
                    <i class='bx bx-user'></i>
                    <span>Profile</span>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <button class="logout-btn" onclick="window.location.href='{% url 'logout' %}'">
                <i class='bx bx-log-out'></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <div class="dashboard-container">
            <!-- Welcome Banner -->
            <section class="welcome-banner">
                <div class="banner-content">
                    <div class="banner-left">
                        <p class="welcome-date" id="todayDate"></p>
                        <h1 class="welcome-title">
                            <span id="welcomeTyped"></span>
                            <span class="typing-cursor">|</span>
                        </h1>
                        <p class="welcome-subtitle">Track your courses and evaluate your teachers</p>
                    </div>
                    <div class="banner-right">
                        <div class="banner-image">
                            {% if student.profile_picture %}
                                <img src="{{ student.profile_picture.url }}" alt="{{ student.user.get_full_name }}">
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ student.user.get_full_name|urlencode }}&background=800020&color=fff&size=120&bold=true" alt="{{ student.user.get_full_name }}">
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Dashboard Main Content -->
            <main class="dashboard-main" id="dashboardMain">
                <div class="section-header">
                    <h2>Overview</h2>
                    <p>Your academic performance at a glance</p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">
                            <i class='bx bx-book'></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ subjects|length }}</h3>
                            <p>Total Subjects</p>
                        </div>
                    </div>

                    <div class="stat-card stat-warning">
                        <div class="stat-icon">
                            <i class='bx bx-clock'></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ pending_evaluations }}</h3>
                            <p>Pending Evaluations</p>
                        </div>

                    </div>

                    <div class="stat-card stat-success">
                        <div class="stat-icon">
                            <i class='bx bx-check-circle'></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ evaluations_count }}</h3>
                            <p>Completed Evaluations</p>
                        </div>
                    </div>

                    <div class="stat-card stat-info">
                        <div class="stat-icon">
                            <i class='bx bx-trending-up'></i>
                        </div>
                        <div class="stat-content">
                            {% if pending_evaluations == 0 %}
                                <h3>100%</h3>
                                <p>Evaluation Progress</p>
                                <small>All Teachers Evaluated</small>
                            {% else %}
                                <h3>{{ progress_percentage|floatformat:0 }}%</h3>
                                <p>Evaluation Progress</p>
                                <small>{{ progress_completed }}/{{ progress_total }} Teachers</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        <button class="action-btn" data-page="evaluate">
                            <i class='bx bx-clipboard-check'></i>
                            <span>Evaluate Teachers</span>
                        </button>
                        <button class="action-btn" data-page="subjects">
                            <i class='bx bx-book'></i>
                            <span>View My Subjects</span>
                        </button>
                        <button class="action-btn" data-page="history">
                            <i class='bx bx-history'></i>
                            <span>View History</span>
                        </button>
                    </div>
                </div>
            </main>

            <!-- Evaluate Teachers Section -->
            <main class="dashboard-main" id="evaluateMain" style="display: none;">
                <div class="section-header">
                    <h2>Evaluate Teachers</h2>
                    <p>Browse and evaluate teachers from your department</p>
                </div>

                <div class="content-grid">
                    {% if teachers %}
                        {% for teacher in teachers %}
                        <div class="teacher-card">
                            <div class="teacher-header">
                                <div class="teacher-avatar">
                                    {% if teacher.profile_picture %}
                                        <img src="{{ teacher.profile_picture.url }}" alt="{{ teacher.user.get_full_name }}">
                                    {% else %}
                                        <img src="https://ui-avatars.com/api/?name={{ teacher.user.get_full_name|urlencode }}&background=800020&color=fff&size=80">
                                    {% endif %}
                                </div>
                                <div class="teacher-info">
                                    <h3>{{ teacher.user.get_full_name }}</h3>
                                    <span class="department-badge">{{ teacher.department.code }}</span>
                                    <p class="department-name">{{ teacher.department.name }}</p>
                                </div>
                            </div>

                            <div class="teacher-rating">
                                <i class="fas fa-star"></i>
                                <span>{{ teacher.get_average_rating }}</span>
                            </div>

                            <div class="progress-section">
                                <div class="progress-header">
                                    <span>Evaluation Progress</span>
                                    <span class="progress-percent">{{ teacher.get_evaluation_progress.percentage|floatformat:0 }}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{ teacher.get_evaluation_progress.percentage|floatformat:0 }}%;"></div>
                                </div>
                                <p class="progress-text">
                                    {{ teacher.get_evaluation_progress.completed }}/{{ teacher.get_evaluation_progress.total_possible }} Students
                                </p>
                            </div>

                            {% if evaluation_is_open %}
                                <a href="{% url 'evaluate_teacher' teacher.id %}" class="btn-evaluate">
                                    <i class="fas fa-star"></i> Evaluate Teacher
                                </a>
                            {% else %}
                                <button class="btn-disabled" disabled>
                                    <i class="fas fa-lock"></i> Evaluation Closed
                                </button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class='bx bx-check-circle'></i>
                            <h3>All Teachers Evaluated!</h3>
                            <p>You have successfully evaluated all teachers in your department.</p>
                        </div>
                    {% endif %}
                </div>
            </main>

            <!-- My Subjects Section -->
            <main class="dashboard-main" id="subjectsMain" style="display: none;">
                <div class="section-header">
                    <h2>My Subjects</h2>
                    <p>
                        {% if has_cor_assignments %}
                            Subjects assigned based on your COR
                        {% else %}
                            Subjects in your department ({{ student.department.code }})
                        {% endif %}
                    </p>
                </div>

                <div class="content-grid">
                    {% if subjects %}
                        {% for subject in subjects %}
                        <div class="subject-card">
                            <div class="subject-header">
                                {% if subject.subject_name %}
                                    <h3>{{ subject.subject_name }}</h3>
                                    <span class="subject-code">{{ subject.subject_code }}</span>
                                    <span class="badge badge-cor">COR Assigned</span>
                                {% else %}
                                    <h3>{{ subject.name }}</h3>
                                    <span class="subject-code">{{ subject.code }}</span>
                                    <span class="badge badge-year">Year {{ subject.year_level }}</span>
                                {% endif %}
                            </div>

                            <div class="subject-schedule">
                                <i class='bx bx-time'></i>
                                <span>
                                    {% if subject.get_schedule %}
                                        {{ subject.get_schedule }}
                                    {% else %}
                                        Schedule TBA
                                    {% endif %}
                                </span>
                            </div>

                            {% if subject.teacher %}
                                <div class="subject-teacher">
                                    <i class='bx bx-user'></i>
                                    <span>{{ subject.teacher.user.get_full_name }}</span>
                                </div>
                            {% elif not subject.subject_name and subject.teachers %}
                                <div class="subject-teachers">
                                    {% for teacher in subject.teachers.all %}
                                        <div class="teacher-chip">
                                            {% if teacher.profile_picture %}
                                                <img src="{{ teacher.profile_picture.url }}" alt="{{ teacher.user.get_full_name }}">
                                            {% else %}
                                                <img src="https://ui-avatars.com/api/?name={{ teacher.user.get_full_name|urlencode }}&background=800020&color=fff&size=32">
                                            {% endif %}
                                            <span>{{ teacher.user.get_full_name }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class='bx bx-book'></i>
                            <h3>No Subjects Found</h3>
                            <p>No subjects found for your year level.</p>
                        </div>
                    {% endif %}
                </div>
            </main>

            <!-- Evaluation History Section -->
            <main class="dashboard-main" id="historyMain" style="display: none;">
    <div class="section-header">
        <h2>Evaluation History</h2>
        <p>Your past evaluations</p>
    </div>

    <div class="content-grid">
        {% if evaluations %}
            {% for evaluation in evaluations %}
            <div class="history-card">
                <div class="history-header">
                    <div class="history-title">
                        <h3>{{ evaluation.subject.name }}</h3>
                        <span class="subject-code">{{ evaluation.subject.code }}</span>
                    </div>
                    <button class="btn-view-details" onclick="openEvaluationModal(this)" data-eval-id="{{ evaluation.id }}">
                        <i class='bx bx-show'></i> View
                    </button>
                </div>

                <div class="history-teacher">
                    {% if evaluation.teacher.profile_picture %}
                        <img src="{{ evaluation.teacher.profile_picture.url }}" alt="{{ evaluation.teacher.user.get_full_name }}">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ evaluation.teacher.user.get_full_name|urlencode }}&background=800020&color=fff&size=50">
                    {% endif %}
                    <div>
                        <h4>{{ evaluation.teacher.user.get_full_name }}</h4>
                        <p class="rating">
                            <i class="fas fa-star"></i> {{ evaluation.teacher.get_average_rating }}
                        </p>
                    </div>
                </div>

                <div class="history-footer">
                    <span class="completed-badge">
                        <i class='bx bx-check-circle'></i>
                        Completed
                    </span>
                    <span class="eval-date">{{ evaluation.created_at|date:"M d, Y" }}</span>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class='bx bx-history'></i>
                <h3>No Evaluations Yet</h3>
                <p>You have not submitted any evaluations yet.</p>
            </div>
        {% endif %}
    </div>
</main>

<!-- ALL MODALS PLACED HERE - OUTSIDE THE CONTENT GRID -->
{% if evaluations %}
    {% for evaluation in evaluations %}
    <div class="evaluation-modal" id="modal-{{ evaluation.id }}" style="display:none;">
        <div class="modal-overlay" onclick="closeEvaluationModal('{{ evaluation.id }}')"></div>

        <div class="modal-content">
            <div class="modal-header">
                <h2>Evaluation Details</h2>
                <button class="modal-close" onclick="closeEvaluationModal('{{ evaluation.id }}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">

                <!-- TEACHER INFO -->
                <div class="modal-section">
                    <h3>Teacher Information</h3>
                    <div class="teacher-info-box">
                        {% if evaluation.teacher.profile_picture %}
                            <img src="{{ evaluation.teacher.profile_picture.url }}" alt="{{ evaluation.teacher.user.get_full_name }}">
                        {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ evaluation.teacher.user.get_full_name|urlencode }}&background=800020&color=fff&size=60">
                        {% endif %}

                        <div>
                            <h4>{{ evaluation.teacher.user.get_full_name }}</h4>
                            <p>{{ evaluation.subject.code }} — {{ evaluation.subject.name }}</p>
                            <p class="rating">
                                <i class="fas fa-star"></i>
                                {{ evaluation.get_average_rating }}/5
                            </p>
                        </div>
                    </div>
                </div>

                <!-- RATINGS SUMMARY -->
                <div class="modal-section">
                    <h3>Ratings Summary</h3>
                    <div class="ratings-grid">

                        <div class="rating-item">
                            <span>Presentation of Lesson</span>
                            <strong>{{ evaluation.get_presentation_average }}/5</strong>
                        </div>

                        <div class="rating-item">
                            <span>Development of Lesson</span>
                            <strong>{{ evaluation.get_development_average }}/5</strong>
                        </div>

                        <div class="rating-item">
                            <span>Student Behavior</span>
                            <strong>{{ evaluation.get_student_behavior_average }}/5</strong>
                        </div>

                        <div class="rating-item">
                            <span>Wrap-Up</span>
                            <strong>{{ evaluation.get_wrapup_average }}/5</strong>
                        </div>

                    </div>

                    <div class="average-rating">
                        <strong>Overall Average: {{ evaluation.get_average_rating }}/5</strong>
                    </div>
                </div>

                <!-- PROBLEMS MET -->
                <div class="modal-section">
                    <h3>Problems Encountered</h3>
                    {% with problems=evaluation.get_problems_severity %}
                        <ul class="problem-list">
                            <li>Late in Class: <strong>{{ problems.late }}</strong></li>
                            <li>Absenteeism: <strong>{{ problems.absent }}</strong></li>
                            <li>Long Video Presentation: <strong>{{ problems.video }}</strong></li>
                        </ul>
                    {% endwith %}
                </div>

                <!-- SUGGESTIONS -->
                <div class="modal-section">
                    <h3>Suggestions</h3>
                    <p>{{ evaluation.suggestions }}</p>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer">
                    <small>
                        Evaluated on {{ evaluation.created_at|date:"M d, Y" }} |
                        {{ evaluation.semester.name }} · {{ evaluation.academic_year.name }}
                    </small>
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

            <!-- Announcements Section -->
            <main class="dashboard-main" id="announcementsMain" style="display: none;">
                <div class="section-header">
                    <h2>Announcements</h2>
                    <p>Latest announcements and updates</p>
                </div>

                <div class="empty-state">
                    <i class='bx bx-bell'></i>
                    <h3>No Announcements</h3>
                    <p>No announcements available. Check back later.</p>
                </div>
            </main>

            <!-- Profile Section -->
            <main class="dashboard-main" id="profileMain" style="display: none;">
                <div class="section-header">
                    <h2>Profile</h2>
                    <p>Your account details</p>
                </div>

                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <h3>{{ student.user.get_full_name }}</h3>
                            <p>{{ student.student_id }}</p>
                        </div>

                        <div class="profile-details">
                            <div class="detail-item">
                                <i class="fas fa-envelope"></i>
                                <div>
                                    <label>Email</label>
                                    <p>{{ student.user.email }}</p>
                                </div>
                            </div>

                            <div class="detail-item">
                                <i class="fas fa-building"></i>
                                <div>
                                    <label>Department</label>
                                    <p>{{ student.department.name }} ({{ student.department.code }})</p>
                                </div>
                            </div>

                            <div class="detail-item">
                                <i class="fas fa-users"></i>
                                <div>
                                    <label>Section</label>
                                    <p>{{ student.section|default:"N/A" }}</p>
                                </div>
                            </div>

                            <div class="detail-item">
                                <i class="fas fa-layer-group"></i>
                                <div>
                                    <label>Year Level</label>
                                    <p>{{ student.get_year_level_display }}</p>
                                </div>
                            </div>

                            <div class="detail-item">
                                <i class="fas fa-graduation-cap"></i>
                                <div>
                                    <label>Course</label>
                                    <p>{{ student.course }}</p>
                                </div>
                            </div>

                            {% if student.has_cor %}
                            <div class="detail-item">
                                <i class="fas fa-file-alt"></i>
                                <div>
                                    <label>COR Status</label>
                                    <p><span class="badge badge-success">Uploaded</span></p>
                                </div>
                            </div>
                            {% endif %}

                            {% if student.has_assigned_subjects %}
                            <div class="detail-item">
                                <i class="fas fa-book"></i>
                                <div>
                                    <label>Assigned Subjects</label>
                                    <p><span class="badge badge-primary">{{ student.assigned_subjects.count }} subjects</span></p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Scripts -->
    <script src="{% static 'js/studentDashboard.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initWelcomeBanner === 'function') {
                initWelcomeBanner('{{ user.get_full_name|escapejs }}');
            }
        });
        
    </script>
</body>
</html>